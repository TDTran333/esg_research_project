---
title: "Research Project: What is the peer performance of Green and Brown firms in the SP1500 index universe?"
author: "TTD"
date: "14/12/2020"
output: 
  html_document:
    toc: true
params:
  core: 1
  hac: FALSE
  subDir: "2009-2017"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

<style>
h1.title {
  font-size: 20px;
}
blockquote {
    font-size: 14px;
}
</style>

# Introduction

[Insert the goal of the research paper, Methodology, Key results]

### Load Libraries and data
```{r, echo=TRUE, message=FALSE, warning=FALSE}
library(here)             # Relative paths
library(tidyverse)        # Data manipulation
library(tidylog)          # Info about dataframe
library(lubridate)        # Manage dates
library(broom)            # Tidy stat functions output
library(summarytools)     # Summary stats
library(PeerPerformance)  # Alpha screening

sp <- readRDS(here("data", params$subDir, "mthly_data_sp.rds"))
factor <- readRDS(here("data", params$subDir, "mthly_factor_mat.rds"))
```

### Data Info
+----------+------+---------------------------------------------+
| variable | type | details                                     |
+==========+======+=============================================+
| permno   | chr  | firm id                                     |
+----------+------+---------------------------------------------+
| date     | date | date                                        |
+----------+------+---------------------------------------------+
| ret_rf   | dbl  | excess return                               |
+----------+------+---------------------------------------------+
| ghg      | dbl  | ghg emission intensity (scope 1&2&3 / rev)  |
+----------+------+---------------------------------------------+
| envscore | dbl  | env score by refinitiv                      |
+----------+------+---------------------------------------------+
| spmim    | dbl  | sp id: sp500 (10) / sp400 (91) / sp600 (92) |
+----------+------+---------------------------------------------+
| mkt_rf   | dbl  | mkt premium                                 |
+----------+------+---------------------------------------------+
| hml      | dbl  | high minus low (value factor)               |
+----------+------+---------------------------------------------+
| smb      | dbl  | small minus big (small cap factor)          |
+----------+------+---------------------------------------------+
| cma      | dbl  | cons mins aggr (investment factor)          |
+----------+------+---------------------------------------------+
| rmw      | dbl  | robust minus weak (profitability factor)    |
+----------+------+---------------------------------------------+
| mom      | dbl  | up minus down (momentum factor)             |
+----------+------+---------------------------------------------+

### Data Visualization
```{r message=FALSE, results=FALSE}

f_summarize_data <- function(df, x) {
  {{ df }} %>%
    group_by(date) %>%
    filter(!is.na({{ x }})) %>%
    summarize(avg = mean({{ x }}),
              median = median({{ x }}),
              q25 = quantile({{ x }}, 0.25),
              q75 = quantile({{ x }}, 0.75))
}

sp %>%
  f_summarize_data(ghg) %>%
  ggplot(aes(x = date)) +
  geom_line(aes(y = avg), color = "red", size = 1.2) +
  geom_line(aes(y = median), color = "blue", lty = 2, size = 1.2) +
  geom_ribbon(aes(ymin = q25, ymax = q75), alpha = 0.25) +
  labs(x = "Date",
       y = "Tonnes of CO2-equivalent GHG",
       title = "Greenhouse Gas Emissions Intensity over time.",
       subtitle = "Ribbon : 25th-75th percentile")

sp %>% 
  ggplot(aes(ghg)) +
  geom_histogram()

sp %>%
  f_summarize_data(envscore) %>%
  ggplot(aes(x = date)) +
  geom_line(aes(y = avg), color = "red", size = 1.2) +
  geom_line(aes(y = median), color = "blue", lty = 2, size = 1.2) +
  geom_ribbon(aes(ymin = q25, ymax = q75), alpha = 0.25) +
  labs(x = "Date",
       y = "Environment score",
       title = "Environment score over time.",
       subtitle = "Ribbon : 25th-75th percentile")

sp %>% 
  ggplot(aes(envscore)) +
  geom_histogram()
```

### Data Analysis

##### Count number of firms per year
```{r, message=FALSE}
t1 <- sp %>%
  group_by(year = year(date)) %>%
  summarize(n_obs = n(),
            n_firms = n_distinct(permno))
t2 <- sp %>%
  filter(!is.na(ghg)) %>% 
  group_by(year = year(date)) %>%
  summarize(n_obs = n(),
            n_firms = n_distinct(permno))

t1 %>% 
  inner_join(t2, by = "year", suffix = c("_total", "_ghg")) %>% 
  janitor::adorn_totals() %>% 
  mutate(pct_ghg = (n_firms_ghg / n_firms_total) * 100) %>%
  knitr::kable(caption = "Percent of firms with ghg data.",
               align = "c",
               digits = 2,
               booktabs = TRUE)

t2 %>% select(n_firms_ghg) %>% sum()
```

##### Summary Statistics
```{r}

sp %>% 
  group_by(year(date)) %>% 
  select(ghg, envscore) %>% 
  descr()

sp %>% 
  select(ghg, envscore) %>% 
  descr()

sp %>%
  filter(!is.na(ghg)) %>% 
  ggplot(aes(ghg)) +
  geom_boxplot() +
  facet_wrap(~year(date)) +
  coord_flip()

sp %>%
  group_by(year(date), permno) %>%
  summarize(avg_yrly_ghg = mean(ghg),
            avg_yrly_envscore = mean(envscore)) %>%
  ungroup() %>%
  select(avg_yrly_ghg, avg_yrly_envscore) %>%
  descr() %>%
  knitr::kable(caption = "GHG Emission Intensity and Environment score  data",
               align = "c",
               digits = 2,
               booktabs = TRUE)
```

### Alpha screening

### Setup firms return data for alphaScreening
```{r}
sp500_subset %>% 
  select_if(~ !any(is.na(.))) %>% 
  group_by(permno) %>%
  select(ret) %>% 
  count() %>% 
  ggplot(aes(n)) +
  geom_bar() +
  labs(title = "Number of available monthly returns during 2009-2018")

ret_mat <- sp500_subset %>%
  select(date, permno, ret_rf) %>%
  mutate(ret_rf = ret_rf / 100) %>% 
  pivot_wider(names_from = permno, values_from = ret_rf) %>%
  select_if(~ !any(is.na(.))) %>% 
  select(-date) %>% 
  unnest(cols = c()) %>% 
  as.matrix()

green <- sp500_subset %>% 
  filter(ghg_total < quantile(ghg_total, 0.25)) %>% 
  summarize(permno = unique(permno))

g_ret_mat <- sp500_subset %>%
  filter(permno %in% green[[1]]) %>% 
  select(date, permno, ret_rf) %>%
  mutate(ret_rf = ret_rf / 100) %>% 
  pivot_wider(names_from = permno, values_from = ret_rf) %>%
  select_if(~ !any(is.na(.))) %>% 
  select(-date) %>% 
  unnest(cols = c()) %>% 
  as.matrix()

brown <- sp500_subset %>% 
  filter(ghg_total > quantile(ghg_total, 0.75)) %>% 
  summarize(permno = unique(permno))

b_ret_mat <- sp500_subset %>%
  filter(permno %in% brown[[1]]) %>% 
  select(date, permno, ret_rf) %>%
  mutate(ret_rf = ret_rf / 100) %>% 
  pivot_wider(names_from = permno, values_from = ret_rf) %>%
  select_if(~ !any(is.na(.))) %>% 
  select(-date) %>% 
  unnest(cols = c()) %>% 
  as.matrix()

neutral_ret_mat <- sp500_subset %>%
  filter(!(permno %in% green[[1]]) & !(permno %in% brown[[1]])) %>% 
  select(date, permno, ret_rf) %>%
  mutate(ret_rf = ret_rf / 100) %>% 
  pivot_wider(names_from = permno, values_from = ret_rf) %>%
  select_if(~ !any(is.na(.))) %>% 
  select(-date) %>% 
  unnest(cols = c()) %>% 
  as.matrix()
  
non_disclosed_mat <- sp500 %>%
  filter(is.na(ghg_total),
         year >= 2009 & year != 2018) %>%
  select(date, permno, ret_rf) %>%
  mutate(ret_rf = ret_rf / 100) %>% 
  pivot_wider(names_from = permno, values_from = ret_rf) %>%
  select_if(~ !any(is.na(.))) %>% 
  select(-date) %>% 
  unnest(cols = c()) %>% 
  as.matrix()
  
```

<!-- ## To-do: simplify the code with array -->

<!-- ```{r} -->
<!-- f_make_graphs <- function(df, title) { -->
<!--   pi <- df[8:10] %>%  -->
<!--     bind_rows() %>%  -->
<!--     select(pipos, pizero, pineg) %>% -->
<!--     arrange(desc(pipos), pineg, pizero) -->

<!--   cex = cex.axis = 0.8 -->
<!--   par(mfrow = c(1, 2)) -->
<!--   plot(12 * 100 * sort(df$alpha, decreasing = TRUE), 1:length(df$alpha), type = 'b', las = 1, pch = 20, cex = cex, cex.axis = cex.axis,  -->
<!--        xlab = "", ylab = "", main = "alpha", axes = FALSE) -->
<!--   box(); grid() -->
<!--   labs = seq(-30, 60, by = 10) -->
<!--   axis(side = 1, at = labs, labels = paste0(labs, "%"), cex.axis = cex.axis) -->
<!--   axis(side = 2, at = 1:length(df$alpha), labels = 1:length(df$alpha), las = 1, cex.axis = cex.axis) -->

<!--   mainstr = expression(hat(pi)^'+'*' / '*hat(pi)^0*' / '*hat(pi)^'-') -->
<!--   barplot(t(100 * pi), horiz = TRUE, names.arg = NULL, col = c(gray(0), gray(0.8), gray(0.5)), -->
<!--           space = 0, xlab = "", xlim = c(0, 100), cex.names = cex.axis, border = NA, -->
<!--           cex.axis = cex.axis, main = mainstr, las = 1, axes = FALSE) -->
<!--   labs = seq(0, 100, by = 25) -->
<!--   axis(side = 1, at = labs, labels = paste0(labs, "%"), cex.axis = cex.axis) -->
<!--   box() -->
<!--   x = seq(from = 104, to = -4, length.out = 200) -->
<!--   y = seq(from = 0, to = 100, length.out = 200) -->
<!--   par(new = TRUE); plot(x, y, type = 'l', lty = "dashed", lwd = 1, xlim = c(0, 100), ylim = c(0, 100), axes = FALSE, ylab = "", xlab = "") -->
<!--   par(new = TRUE); plot(x-27.5, y, type = 'l', lty = "dashed", lwd = 1, xlim = c(0, 100), ylim = c(0, 100), axes = FALSE, ylab = "", xlab = "") -->
<!--   par(new = TRUE); plot(x+27.5, y, type = 'l', lty = "dashed", lwd = 1, xlim = c(0, 100), ylim = c(0, 100), axes = FALSE, ylab = "", xlab = "") -->
<!--   mtext(title, side = 3, line = -1.5, outer = TRUE, cex = 1.25) -->
<!-- } -->
<!-- ``` -->

<!-- ### alphaScreening -->

<!-- #### Three-factor model -->
<!-- ```{r} -->
<!-- ctr <- list(nCore = 1) -->
<!-- results_all_3f <- alphaScreening(ret_mat, factors = three_factor, control = ctr) -->
<!-- results_green_3f <- alphaScreening(g_ret_mat, factors = three_factor, control = ctr) -->
<!-- results_brown_3f <- alphaScreening(b_ret_mat, factors = three_factor, control = ctr) -->
<!-- results_between_3f <- alphaScreening(neutral_ret_mat, factors = three_factor, control = ctr) -->
<!-- results_non_disclosed_3f <- alphaScreening(non_disclosed_mat, factors = three_factor, control = ctr) -->

<!-- results_all_3f %>% f_make_graphs("All firms - Three-factor model") -->
<!-- results_green_3f %>% f_make_graphs("Green firms - Three-factor model") -->
<!-- results_brown_3f %>% f_make_graphs("Brown firms - Three-factor model") -->
<!-- results_between_3f %>% f_make_graphs("In-between firms - Three-factor model") -->
<!-- results_non_disclosed_3f %>% f_make_graphs("Non-disclosing firms - Three-factor model") -->
<!-- ``` -->

<!-- #### Six-factor model -->
<!-- ```{r} -->
<!-- results_all_6f <- alphaScreening(ret_mat, factors = six_factor, control = ctr) -->
<!-- results_green_6f <- alphaScreening(g_ret_mat, factors = six_factor, control = ctr) -->
<!-- results_brown_6f <- alphaScreening(b_ret_mat, factors = six_factor, control = ctr) -->
<!-- results_between_6f <- alphaScreening(neutral_ret_mat, factors = six_factor, control = ctr) -->
<!-- results_non_disclosed_6f <- alphaScreening(non_disclosed_mat, factors = six_factor, control = ctr) -->

<!-- results_all_6f %>% f_make_graphs("All firms - Six-factor model") -->
<!-- results_green_6f %>% f_make_graphs("Green firms - Six-factor model") -->
<!-- results_brown_6f %>% f_make_graphs("Brown firms - Six-factor model") -->
<!-- results_between_6f %>% f_make_graphs("In-between firms - Six-factor model") -->
<!-- results_non_disclosed_6f %>% f_make_graphs("Non-disclosing firms - Six-factor model") -->
<!-- ``` -->
