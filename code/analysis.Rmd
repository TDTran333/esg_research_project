---
title: "Research Project: What is the peer performance of Green and Brown firms in the SP1500 index universe?"
author: "TTD"
date: "14/12/2020"
output: 
  html_document:
    toc: true
params:
  ctr: list(nCore = 1)
  subDir: "2009-2017"
  bucket: 5
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

<style>
h1.title {
  font-size: 20px;
}
caption {
  font-weight: bold;
  font-size: 16px;
} 
</style>

# Introduction

[Insert the goal of the research paper]
[Insert comment about the data]
[Insert comment about the methodology]
[Insert summaries of results]

```{r Load Libraries and Data, echo=TRUE, message=FALSE, warning=FALSE}
library(here)             # Relative paths
library(tidyverse)        # Data manipulation
library(tidylog)          # Info about dataframe
library(lubridate)        # Manage dates
library(janitor)          # Clean data
library(summarytools)     # Summary stats
library(PeerPerformance)  # Alpha screening

source(here("function", "f_summarize_plot.R"))
source(here("function", "f_tbl_screening.R"))
source(here("function", "f_screenplot.R"))

sp <- readRDS(here("data", params$subDir, "mthly_data_sp.rds"))
factor <- readRDS(here("data", params$subDir, "mthly_factor.rds"))
```

### Data Info

[Insert comments on how the data was cleaned.]

##### Variables description
+----------+------+---------------------------------------------+
| variable | type | details                                     |
+==========+======+=============================================+
| permno   | chr  | firm id                                     |
+----------+------+---------------------------------------------+
| date     | date | date                                        |
+----------+------+---------------------------------------------+
| ret_rf   | dbl  | excess return                               |
+----------+------+---------------------------------------------+
| ghg      | dbl  | ghg emission intensity (scope 1&2&3 / rev)  |
+----------+------+---------------------------------------------+
| envscore | dbl  | env score by refinitiv                      |
+----------+------+---------------------------------------------+
| spmim    | dbl  | sp id: sp500 (10) / sp400 (91) / sp600 (92) |
+----------+------+---------------------------------------------+
| mkt_rf   | dbl  | mkt premium                                 |
+----------+------+---------------------------------------------+
| hml      | dbl  | high minus low (value factor)               |
+----------+------+---------------------------------------------+
| smb      | dbl  | small minus big (small cap factor)          |
+----------+------+---------------------------------------------+
| cma      | dbl  | cons mins aggr (investment factor)          |
+----------+------+---------------------------------------------+
| rmw      | dbl  | robust minus weak (profitability factor)    |
+----------+------+---------------------------------------------+
| mom      | dbl  | up minus down (momentum factor)             |
+----------+------+---------------------------------------------+

### Data Visualization

[Comment on the graphs and histograms.]

```{r Data Visualization, message=FALSE, results=FALSE}
sp %>%
  f_summarize_plot(ghg) %>%
  ggplot(aes(x = date, y = value, color = measure)) +
  geom_line(size = 1.25) +
  geom_ribbon(aes(ymin = q25, ymax = q75), alpha = 0.25, color = "blue") +
  labs(x = "Date",
       y = "Tonnes of CO2-equivalent GHG",
       title = "Greenhouse Gas Emissions Intensity over time.",
       subtitle = paste("Ribbon: 25th-75th percentile. Period: ", params$subDir))

sp %>%
  group_by(permno) %>% 
  summarize(avg_ghg = mean(ghg, na.rm = TRUE)) %>%
  filter(!is.nan(avg_ghg)) %>% 
  ggplot(aes(avg_ghg)) +
  geom_histogram() +
  labs(x = "GHG",
       y = "Number of firms",
       title = "Histogram of Firms Average GHG Intensity Emission.",
       subtitle = paste("Period: ", params$subDir))

sp %>%
  f_summarize_plot(envscore) %>%
  ggplot(aes(x = date, y = value, color = measure)) +
  geom_line(size = 1.25) +
  geom_ribbon(aes(ymin = q25, ymax = q75), alpha = 0.25, color = "blue") +
  labs(x = "Date",
       y = "Environment Score",
       title = "Environment Score over Time.",
       subtitle = paste("Ribbon: 25th-75th percentile. Period: ", params$subDir))

sp %>%
  group_by(permno) %>% 
  summarize(avg_envscore = mean(envscore, na.rm = TRUE)) %>%
  filter(!is.nan(avg_envscore)) %>% 
  ggplot(aes(avg_envscore)) +
  geom_histogram() +
  labs(x = "Environment Score",
       y = "Number of Firms",
       title = "Histogram of Firms Average Environment Score.",
       subtitle = paste("Period: ", params$subDir))

```

### Data Analysis

##### Number of firms per year

[Insert comment on number of firms]


```{r Number of Firms per Year, message=FALSE}
t1 <- sp %>%
  group_by(year = year(date)) %>%
  summarize(n_obs = n(),
            n_firms = n_distinct(permno))
t2 <- sp %>%
  filter(!is.na(ghg)) %>% 
  group_by(year = year(date)) %>%
  summarize(n_obs = n(),
            n_firms = n_distinct(permno))

t1 %>% 
  inner_join(t2, by = "year", suffix = c("_total", "_ghg")) %>% 
  adorn_totals() %>% 
  mutate(pct_ghg = (n_firms_ghg / n_firms_total) * 100) %>%
  knitr::kable(caption = "Percent of Firms with GHG Emission Intensity Data.",
               align = "c",
               digits = 2,
               booktabs = TRUE)
```

##### Descriptive Statistics

[Insert comment on the descriptive statistics]

```{r Descriptive Statistics}

sp %>% 
  group_by(Year = year(date)) %>% 
  select(ghg, envscore) %>% 
  descr(headings = FALSE)

sp %>% 
  select(ghg, envscore) %>% 
  descr() %>%
  knitr::kable(caption = paste("Descriptive Statistics for the period covering: ", params$subDir),
               align = "c",
               digits = 2,
               booktabs = TRUE)

sp %>%
  filter(!is.na(ghg)) %>%
  group_by(year = year(date), permno) %>% 
  summarize(mean = mean(ghg)) %>%
  select(-permno) %>% 
  ungroup() %>% 
  ggplot(aes(mean)) +
  geom_boxplot() +
  facet_wrap(~year) +
  labs(x = "GHG",
       title = "Boxplot of Average Firm GHG Emission Intensity per Year.") +
  coord_flip()

sp %>%
  group_by(year(date), permno) %>%
  summarize(mean_ghg = mean(ghg),
            mean_envscore = mean(envscore)) %>%
  ungroup() %>%
  select(mean_ghg, mean_envscore) %>%
  descr() %>%
  knitr::kable(caption = "GHG Emission Intensity and Environment Score Data",
               align = "c",
               digits = 2,
               booktabs = TRUE)
```

### Classifying Firms

[Insert explanation on how we divided the groups]

```{r Generate Groups}
ghg_df <- sp %>%
  select(date, permno, ghg) %>% 
  group_by(year = year(date), permno) %>%
  summarize(avg_ghg_yr = mean(ghg, na.rm = TRUE)) %>%
  group_by(permno) %>%
  mutate(avg_ghg_5yr = zoo::rollapplyr(avg_ghg_yr, 
                             width = 5,
                             FUN = function(x) mean(x, na.rm = TRUE), 
                             fill = NA, 
                             partial = TRUE,
                             align = "right")) %>%
  mutate_at(vars(avg_ghg_yr, avg_ghg_5yr), ~replace(., is.nan(.), NA)) %>% 
  group_by(year) %>% 
  mutate(q_25 = quantile(avg_ghg_5yr, probs = 0.25, na.rm = TRUE),
         q_75 = quantile(avg_ghg_5yr, probs = 0.75, na.rm = TRUE)) %>%
  mutate(status = case_when(is.na(avg_ghg_5yr)  ~ "U",
                            avg_ghg_5yr <= q_25 ~ "G",
                            avg_ghg_5yr >= q_75 ~ "B",                           
                            avg_ghg_5yr < q_75 & avg_ghg_5yr > q_25 ~ "N")) %>%
  arrange(permno)

color = c("#cb997e", "#06d6a0", "#bfc0c0", "#ffffff")

ghg_df %>% 
  group_by(year, status) %>% 
  count() %>% 
    ggplot(aes(year, n, fill = status)) +
  geom_col(width = 0.8, colour = "black") +
  geom_text(aes(label = n),  position = position_stack(vjust = .5)) +
  scale_fill_manual(values = color) +
  scale_x_continuous(breaks = 2009:2017) +
  labs(x = "Year",
       y = "Firms count",
       title = "Firms grouped into : Brown, Green, Neutral and Undisclosed.")
```

### Transition Matrix

[Insert comment about transition matrix]

```{r Transition Matrix}
data_trans_mat <- ghg_df %>%
  select(year, permno, status) %>%
  pivot_wider(names_from = permno, values_from = status) %>%
  ungroup() %>% 
  select(-year) %>% 
  as.matrix()

f_trans_matrix <- function(X, byrow = T, prob=T)
{
    if(byrow) trans_mat <- table( c(X[,-ncol(X)]), c(X[,-1]) )
    else trans_mat <- table( c(X[-nrow(X),]), c(X[-1,]) )
    if(prob) trans_mat <- trans_mat / rowSums(trans_mat)
    trans_mat
}

data_trans_mat %>% 
  f_trans_matrix(byrow = F) %>% 
  knitr::kable(caption = "Transition Matrix",
               align = "c",
               digits = 4,
               booktabs = TRUE)

# Check
library(markovchain)
mcFit <- markovchainFit(data= data_trans_mat, byrow = FALSE)
mcFit

mcFit$estimate@transitionMatrix %>%
  knitr::kable(caption = "Transition Matrix",
               align = "c",
               digits = 4,
               booktabs = TRUE)

mcFit$upperEndpointMatrix %>%
  knitr::kable(caption = "Transition Matrix Upper Confidence Interval",
               align = "c",
               digits = 4,
               booktabs = TRUE)

mcFit$lowerEndpointMatrix %>%
  knitr::kable(caption = "Transition Matrix Lower Confidence Interval",
               align = "c",
               digits = 4,
               booktabs = TRUE)
```

### Alpha screening

[Insert comment about the methodology]

```{r Group Id}
f_create_id <- function(df) {
  {{ df }} %>%
  select(year, permno) %>%
  pivot_wider(names_from = year, values_from = permno) %>% 
  clean_names() %>%
  map(., unlist)
}

id_all <- ghg_df  %>% f_create_id()
id_green <- ghg_df %>% filter(status == "G") %>% f_create_id()
id_brown <- ghg_df %>% filter(status == "B") %>% f_create_id()
id_neutral <- ghg_df %>% filter(status == "N") %>% f_create_id()
id_undisclosed <- ghg_df %>% filter(status == "U") %>% f_create_id()


ghg_df %>%
  select(year, permno) %>%
  pivot_wider(names_from = year, values_from = permno)
```

```{r Alpha Screening}
# Backward looking Green
input_year <- 2013:2017
id_group <- "green_id$x"
f_alpha_screen(sp, factor, id_group, input_year, backward = TRUE, params$ctr)

#Forward looking Green
input_year <- 2009:2012
id_group <- "green_id$x"
f_alpha_screen(sp, factor, id_group, input_year, backward = FALSE, params$ctr)

# Backward looking Brown
input_year <- 2013:2017
id_group <- "brown_id$x"
f_alpha_screen(sp, factor, id_group, input_year, backward = TRUE, params$ctr)

#Forward looking Brown
input_year <- 2009:2012
id_group <- "brown_id$x"
f_alpha_screen(sp, factor, id_group, input_year, backward = FALSE, params$ctr)



f_alpha_screen <- function(df, factor_df, id_group, input_year, backward = TRUE, control) {
  for (i in input_year) {
  
    if (backward) {
      start_year <- {{i}}
      end_year <- {{i}} - 4
      model <- "Backward-Looking Model"
    } else {
      start_year <- {{i}} + 1
      end_year <- {{i}} + 5
      model <- "Forward-Looking Model"
    }
    
      print(i)
      
      ret <- df %>%
      filter(permno %in% eval(parse(text = paste0(id_group, {{i}})))) %>%
      filter(year(date) <= start_year,
             year(date) >= end_year) %>%
      select(date, permno, ret_rf) %>%
      pivot_wider(names_from = permno, values_from = ret_rf) %>%
      select(-date) %>%
      as.matrix()
    
    fctr <- factor_df %>% 
      filter(year(date) <= start_year,
             year(date) >= end_year) %>%
      select(-date) %>% 
      as.matrix()
    
    alpha_screen <- alphaScreening(ret, factors = fctr, control = control)
    
    result <- alpha_screen %>% 
      as_tibble() %>%
      select(alpha, pizero, pipos, pineg) %>%
      f_tbl_screening(floor(nrow(.) / params$bucket)) %>%
      as.tibble()
    
    f_screenplot(result, paste0(model, "_", id_group, "_", {{i}}))
  }
}


source(here("function", "f_screenplot.R"))
source(here("function", "f_alpha_screen.R"))
```